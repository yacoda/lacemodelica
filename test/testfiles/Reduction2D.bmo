// SPDX-License-Identifier: MIT
// Copyright (c) 2025 Joris Gillis, YACODA

//! base 0.1.0
package 'Reduction2D'
  model 'Reduction2D' "Test model with nested reduction operations (double for loop)"
    parameter Real 'A'[2, 3] "Input matrix";
    parameter Real 'b'[2] "First input array";
    parameter Real 'c'[3] "Second input array";

    Real 'x'(start = 0.0);
    Real 'sumAll' "Sum of all matrix elements using nested sum";
    Real 'productOuter' "Product of row sums";
    Real 'outerProduct' "Sum of outer product b * c^T";

  equation
    der('x') = 0.1;
    // Nested sum: sum(sum(A[i,j] for j in 1:3) for i in 1:2)
    'sumAll' = sum(sum('A'[i, j] for j in 1:3) for i in 1:2);
    // Product of row sums: product(sum(A[i,j] for j in 1:3) for i in 1:2)
    'productOuter' = product(sum('A'[i, j] for j in 1:3) for i in 1:2);
    // Sum of outer product: sum(sum(b[i] * c[j] for j in 1:3) for i in 1:2)
    'outerProduct' = sum(sum('b'[i] * 'c'[j] for j in 1:3) for i in 1:2);

  end 'Reduction2D';
end 'Reduction2D';

// @onnx-test-reference
// Python reference implementation for ONNX runtime testing
// def reference_implementation(inputs):
//     import numpy as np
//     outputs = {}
//
//     # Extract inputs
//     x = inputs['x']
//     der_x = inputs["der(x)"]
//     A = inputs['A']
//     b = inputs['b']
//     c = inputs['c']
//     sumAll = inputs['sumAll']
//     productOuter = inputs['productOuter']
//     outerProduct = inputs['outerProduct']
//
//     # Equation 0: der(x) = 0.1
//     outputs['eq[0]'] = der_x - 0.1
//
//     # Equation 1: sumAll = sum(sum(A[i,j] for j in 1:3) for i in 1:2)
//     expected_sumAll = sum(sum(A[i, j] for j in range(3)) for i in range(2))
//     outputs['eq[1]'] = sumAll - expected_sumAll
//
//     # Equation 2: productOuter = product(sum(A[i,j] for j in 1:3) for i in 1:2)
//     row_sums = [sum(A[i, j] for j in range(3)) for i in range(2)]
//     expected_productOuter = 1.0
//     for rs in row_sums:
//         expected_productOuter *= rs
//     outputs['eq[2]'] = productOuter - expected_productOuter
//
//     # Equation 3: outerProduct = sum(sum(b[i] * c[j] for j in 1:3) for i in 1:2)
//     expected_outerProduct = sum(sum(b[i] * c[j] for j in range(3)) for i in range(2))
//     outputs['eq[3]'] = outerProduct - expected_outerProduct
//
//     # Initial value
//     outputs['start[0]'] = np.array(0.0)
//
//     return outputs
//
// @onnx-test-case
// # Test case 1: A = [[1, 2, 3], [4, 5, 6]], b = [1, 2], c = [1, 2, 3]
// import numpy as np
// x = 0.0
// der_x = 0.1
// A = np.array([[1.0, 2.0, 3.0], [4.0, 5.0, 6.0]])
// b = np.array([1.0, 2.0])
// c = np.array([1.0, 2.0, 3.0])
// sumAll = 21.0  # 1+2+3+4+5+6
// productOuter = 90.0  # (1+2+3) * (4+5+6) = 6 * 15
// outerProduct = 18.0  # sum of outer product = (1+2)*(1+2+3) = 3*6 = 18
// {
//   "x": np.array(x),
//   "der(x)": np.array(der_x),
//   "A": A,
//   "b": b,
//   "c": c,
//   "sumAll": np.array(sumAll),
//   "productOuter": np.array(productOuter),
//   "outerProduct": np.array(outerProduct)
// }
//
// @onnx-test-case
// # Test case 2: A = [[0.5, 1.0, 1.5], [2.0, 2.5, 3.0]], b = [0.5, 1.5], c = [2, 4, 6]
// import numpy as np
// x = 1.0
// der_x = 0.1
// A = np.array([[0.5, 1.0, 1.5], [2.0, 2.5, 3.0]])
// b = np.array([0.5, 1.5])
// c = np.array([2.0, 4.0, 6.0])
// sumAll = 10.5  # 0.5+1+1.5+2+2.5+3
// productOuter = 22.5  # (0.5+1+1.5) * (2+2.5+3) = 3 * 7.5
// outerProduct = 24.0  # (0.5+1.5)*(2+4+6) = 2*12 = 24
// {
//   "x": np.array(x),
//   "der(x)": np.array(der_x),
//   "A": A,
//   "b": b,
//   "c": c,
//   "sumAll": np.array(sumAll),
//   "productOuter": np.array(productOuter),
//   "outerProduct": np.array(outerProduct)
// }
//
// @onnx-test-case
// # Test case 3: A = [[1, -1, 1], [-1, 1, -1]], b = [2, 3], c = [1, 1, 1]
// import numpy as np
// x = 2.0
// der_x = 0.1
// A = np.array([[1.0, -1.0, 1.0], [-1.0, 1.0, -1.0]])
// b = np.array([2.0, 3.0])
// c = np.array([1.0, 1.0, 1.0])
// sumAll = 0.0  # 1-1+1-1+1-1
// productOuter = -1.0  # (1-1+1) * (-1+1-1) = 1 * -1
// outerProduct = 15.0  # (2+3)*(1+1+1) = 5*3 = 15
// {
//   "x": np.array(x),
//   "der(x)": np.array(der_x),
//   "A": A,
//   "b": b,
//   "c": c,
//   "sumAll": np.array(sumAll),
//   "productOuter": np.array(productOuter),
//   "outerProduct": np.array(outerProduct)
// }
//
